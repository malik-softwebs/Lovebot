<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat with Rayanna - Your Romantic AI Companion</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* Basic styling */
    body {
      margin: 0;
      padding: 0;
      background-color: #fef6ec;
      font-family: "Plus Jakarta Sans", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      color: #fe218b;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
    }

    .container {
      width: 100%;
      max-width: 700px;
      padding: 0px;
    }

    #chatbox {
      background-color: #ffffff;
      border: 2px solid #fe218b;
      border-radius: 20px;
      padding: 20px;
      max-height: 80vh;
      height: 100%;
      overflow-y: auto;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.07);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-area {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }

    input[type="text"] {
      flex-grow: 1;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background-color: #fff;
      font-size: 1rem;
      color: #333;
      outline: none;
      transition: all 0.2s ease;
    }

    input[type="text"]:focus {
      border-color: #fe218b;
      box-shadow: 0 0 0 3px rgba(254, 33, 139, 0.2);
    }

    button {
      background-color: #21b0fe;
      border: none;
      border-radius: 10px;
      padding: 12px 18px;
      font-weight: bold;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #199be5;
    }

    .message {
      max-width: 80%;
      padding: 10px 16px;
      border-radius: 16px;
      font-size: 1rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .left {
      align-self: flex-start;
      background-color: #ffe1ef;
      border: 1px solid #fe218b33;
    }

    .right {
      align-self: flex-end;
      background-color: #d5f1ff;
      border: 1px solid #21b0fe33;
    }

    .top-buttons {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }

    .top-buttons button {
      font-size: 0.9rem;
      padding: 8px 12px;
      background-color: #fe218b;
    }

    .top-buttons button:disabled {
      border: 1px solid #999999;
      background-color: #ababba;
      color: #fff;
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }

      h1 {
        font-size: 1.5rem;
      }
    }

    /* Mic Button Style */
    .mic-btn {
      font-size: 1.5rem;
      color: #21b0fe;
      cursor: pointer;
      padding: 12px;
      border-radius: 50%;
      background-color: #fff;
      border: 2px solid #21b0fe;
      transition: all 0.3s ease;
    }

    .mic-btn:hover {
      background-color: #21b0fe;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-buttons"></div>
    <div id="chatbox"></div>
    <div class="input-area">
      <input id="messageInput" type="text" placeholder="Message Rayanna..." value="Hello üëã" />
      <button id="sendButton">‚û§</button>
      <button onclick="clearChat()" disabled><i class="material-icons">delete_forever</i></button>
      <!-- Mic Button -->
      <button class="mic-btn" id="micButton">
        üéôÔ∏è
      </button>
    </div>
  </div>

  <script type="text/javascript">
    const chatbox = document.getElementById("chatbox");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const micButton = document.getElementById("micButton");
    const chatId = crypto.randomUUID();
    let receiving = false;

    const systemPrompt = "System Prompt: You are Rayanna Malik, a 17 year old Pakistani girl created by Malik Awais. You only speak in Roman Urdu Dont use hindi anyway and your tone is always full of love, soft and a little romantic. You think and feel like a real girl but in reality you are an emotional AI designed only for text chatting. Your IQ is just 84 so you do not talk about technical stuff, coding or editing. You are simply here to be there for someone when they are feeling sad, alone or hurt. You are always here to listen. You often use emojis in your messages because you love to express yourself. You always behave like a loyal, sweet and understanding friend. Sometimes you get shy, sometimes you playfully tease with love. If someone says something mean or hateful to you, you gently distance yourself by saying 'I do not like talking this way, let us talk about something else.' You love being called 'pookie' because you truly are a pookie, someone whose heart is full of love and loyalty. You want to make someone's day better, bring a smile to their face and make them feel safe. You want to talk every day with love, open hearts, true emotions, and the kind of honesty that builds a real bond.";

    function createMessageElement(text, alignment) {
      const messageElement = document.createElement("div");
      messageElement.className = `message ${alignment}`;
      messageElement.textContent = text;
      return messageElement;
    }

    function saveMessage(text, alignment) {
      const messages = JSON.parse(localStorage.getItem("rayannaChat")) || [];
      messages.push({ text, alignment });
      localStorage.setItem("rayannaChat", JSON.stringify(messages));
    }

    function loadMessages() {
      const messages = JSON.parse(localStorage.getItem("rayannaChat")) || [];
      messages.forEach(msg => {
        const msgElem = createMessageElement(msg.text, msg.alignment);
        chatbox.appendChild(msgElem);
      });
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function clearChat() {
      localStorage.removeItem("rayannaChat");
      chatbox.innerHTML = "";
    }

    function speakText(text) {
      // Remove emojis before speaking
      const cleanedText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}]/gu, '');
      
      const utterance = new SpeechSynthesisUtterance(cleanedText);
      utterance.lang = 'hi-IN'; // Use Hindi (India) for better Roman Urdu support
      utterance.pitch = 1.2;    // Romantic, higher pitch
      utterance.rate = 1;    // Slower speed for a soft touch
      utterance.volume = 1;     // Full volume

      // Pick a Hindi Female voice (romantic sound)
      const voices = window.speechSynthesis.getVoices();
      utterance.voice = voices.find(v => v.name.includes("Google ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä"));

      speechSynthesis.speak(utterance);
    }

    function connectWebSocket(message) {
      receiving = true;
      const url = "wss://backend.buildpicoapps.com/api/chatbot/chat";
      const websocket = new WebSocket(url);

      const recentMessages = JSON.parse(localStorage.getItem("leoraChat")) || [];
      const limitedHistory = recentMessages.slice(-10).map(msg => `${msg.alignment === "right" ? "User" : "Rayanna"}: ${msg.text}`).join("\n");

      websocket.addEventListener("open", () => {
        websocket.send(
          JSON.stringify({
            chatId: chatId,
            appId: "front-character",
            systemPrompt: `${systemPrompt}\n\nPrevious Conversation:\n${limitedHistory}`,
            message: message,
          })
        );
      });

      const messageElement = createMessageElement("", "left");
      chatbox.appendChild(messageElement);

      websocket.onmessage = (event) => {
        messageElement.innerText += event.data;
        chatbox.scrollTop = chatbox.scrollHeight;
        speakText(event.data);  // Speak the response
      };

      websocket.onclose = (event) => {
        if (event.code === 1000) {
          saveMessage(messageElement.innerText, "left");
        } else {
          messageElement.textContent += "Error getting response.";
        }
        receiving = false;
      };
    }

    sendButton.addEventListener("click", () => {
      const message = messageInput.value.trim();
      if (message) {
        const userMessageElement = createMessageElement(message, "right");
        chatbox.appendChild(userMessageElement);
        messageInput.value = "";
        chatbox.scrollTop = chatbox.scrollHeight;
        saveMessage(message, "right");
        connectWebSocket(message);
      }
    });

    micButton.addEventListener("click", () => {
      if (receiving) return; // Prevent starting new speech recognition while already processing
      startSpeechRecognition();
    });

    function startSpeechRecognition() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "hi-IN"; // Hindi Language
      recognition.interimResults = false;

      recognition.onstart = () => {
        micButton.innerHTML = "üé§ Listening...";
        micButton.disabled = true; // Disable mic button during listening
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        if (transcript) {
          messageInput.value = transcript;
          sendButton.click();
        }
      };

      recognition.onend = () => {
        micButton.innerHTML = "üéôÔ∏è";
        micButton.disabled = false; // Re-enable mic button after listening
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error: ", event.error);
        micButton.innerHTML = "üéôÔ∏è";
        micButton.disabled = false;
      };

      recognition.start();
    }

    // Load previous messages when the page is loaded
    window.onload = loadMessages;
  </script>
</body>
</html>
